<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">
        <link rel="prefetch" href="../../_static/logo.png" as="image">
        <link rel="prefetch" href="../../_static/logo.png" as="image">
        <link rel="prefetch" href="../../_static/logo.png" as="image">

    <link rel="shortcut icon" href="../../_static/favicon.png"><!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>llm_procedure_generation_ga.validators - LLM Procedure Generation GA</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=342596f7" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">LLM Procedure Generation GA</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/logo.png" alt="Logo"/>
  </div>
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/logo.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../_static/logo.png" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Get started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/index.html">User Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api_core.html">Core API</a><input aria-label="Toggle navigation of Core API" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../_autosummary/llm_procedure_generation_ga.html">llm_procedure_generation_ga</a><input aria-label="Toggle navigation of llm_procedure_generation_ga" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/llm_procedure_generation_ga.ga_scaffold_structured.html">llm_procedure_generation_ga.ga_scaffold_structured</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/llm_procedure_generation_ga.helpers.html">llm_procedure_generation_ga.helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/llm_procedure_generation_ga.scorers.html">llm_procedure_generation_ga.scorers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/llm_procedure_generation_ga.validators.html">llm_procedure_generation_ga.validators</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/llm_procedure_generation_ga.ga_scaffold_structured.html">llm_procedure_generation_ga.ga_scaffold_structured</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/llm_procedure_generation_ga.helpers.html">llm_procedure_generation_ga.helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/llm_procedure_generation_ga.scorers.html">llm_procedure_generation_ga.scorers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/llm_procedure_generation_ga.validators.html">llm_procedure_generation_ga.validators</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api_procedures.html">Procedures Plugin API</a><input aria-label="Toggle navigation of Procedures Plugin API" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../_autosummary/procedures.html">procedures</a><input aria-label="Toggle navigation of procedures" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/procedures.builders.html">procedures.builders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/procedures.helpers.html">procedures.helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/procedures.models.html">procedures.models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/procedures.ollama.html">procedures.ollama</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/procedures.pipelines.html">procedures.pipelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/procedures.prompts.html">procedures.prompts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/procedures.repairs.html">procedures.repairs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/procedures.runners.html">procedures.runners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../_autosummary/procedures.schemas.html">procedures.schemas</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/procedures.helpers.html">procedures.helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/procedures.models.html">procedures.models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/procedures.schemas.html">procedures.schemas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/procedures.prompts.html">procedures.prompts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/procedures.builders.html">procedures.builders</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/procedures.repairs.html">procedures.repairs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/procedures.runners.html">procedures.runners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/procedures.pipelines.html">procedures.pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../_autosummary/procedures.ollama.html">procedures.ollama</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for llm_procedure_generation_ga.validators</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">validators.py</span>
<span class="sd">====================</span>

<span class="sd">Validator helpers for *global-state* procedures.</span>

<span class="sd">Design overview</span>
<span class="sd">---------------</span>
<span class="sd">- **Global state**: Steps may read any variable produced by earlier steps or given in</span>
<span class="sd">  the problem. There is no step-to-step pass-through requirement.</span>
<span class="sd">- **Step 1 rule**: The first step must take **exactly** one input: ``problem_text``.</span>
<span class="sd">  (No other inputs will be provided externally.)</span>
<span class="sd">- **Final step rule**: The last step must output exactly ``final_answer`` (a description,</span>
<span class="sd">  not the computed value).</span>
<span class="sd">- **Safety checks**: Every declared input must be resolvable from prior outputs</span>
<span class="sd">  (or ``problem_text``), variables should not be silently redefined, and unused</span>
<span class="sd">  outputs are flagged to keep the procedure minimal and readable.</span>

<span class="sd">All functions return a list of :class:`Diagnostic` objects that can be fed into a</span>
<span class="sd">repair loop. Use :func:`validate_procedure_structured` to run the default suite.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">TypedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">llm_procedure_generation_ga.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">_canon_details</span><span class="p">,</span> <span class="n">_names</span>
<span class="n">JSONDict</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="n">Action</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
    <span class="s2">&quot;PATCH_LOCALLY&quot;</span><span class="p">,</span>            <span class="c1"># small JSON edits are enough</span>
    <span class="s2">&quot;REWRITE_FIRST_STEP&quot;</span><span class="p">,</span>       <span class="c1"># step 1 must be rewritten to only use problem_text</span>
    <span class="s2">&quot;ADD_FINAL_STEP&quot;</span><span class="p">,</span>           <span class="c1"># final step missing; add step that produces final_answer</span>
    <span class="s2">&quot;EXTEND_PROCEDURE_TO_FINAL&quot;</span><span class="p">,</span> <span class="c1"># needs more steps to reach final_answer</span>
    <span class="s2">&quot;ADD_MISSING_PRODUCER&quot;</span>       <span class="c1"># create/insert a producer for an unresolved input</span>
<span class="p">]</span>
<span class="sd">&quot;&quot;&quot;Action: machine-usable repair hints for downstream auto-fix prompts.&quot;&quot;&quot;</span>

<span class="n">Severity</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;repairable&quot;</span><span class="p">,</span> <span class="s2">&quot;fatal&quot;</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;Severity: ``fatal`` means the procedure is not runnable without regeneration or</span>
<span class="sd">structural rewrite; ``repairable`` means a small, local JSON edit should suffice.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Diagnostic">
<a class="viewcode-back" href="../../_autosummary/llm_procedure_generation_ga.validators.html#llm_procedure_generation_ga.validators.Diagnostic">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Diagnostic</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Structured validator finding.</span>

<span class="sd">    Keys</span>
<span class="sd">    ----</span>
<span class="sd">    severity:</span>
<span class="sd">        Either ``&quot;fatal&quot;`` or ``&quot;repairable&quot;``.</span>
<span class="sd">    action:</span>
<span class="sd">        A short, machine-usable hint for an auto-repair prompt (see :data:`Action`).</span>
<span class="sd">    message:</span>
<span class="sd">        Human-readable description of the issue.</span>
<span class="sd">    details:</span>
<span class="sd">        Machine-targeted payload (e.g., step ids, variable names) that an auto-repair</span>
<span class="sd">        routine can use to patch the JSON.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">severity</span><span class="p">:</span> <span class="n">Severity</span>
    <span class="n">action</span><span class="p">:</span> <span class="n">Action</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_dedup_diags</span><span class="p">(</span><span class="n">diags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deduplicate diagnostics by a canonical identity.</span>

<span class="sd">    Two diagnostics are considered the same if ``(severity, action, message, canon(details))``</span>
<span class="sd">    matches. This keeps repair prompts concise when multiple validators surface</span>
<span class="sd">    the same underlying issue.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    diags</span>
<span class="sd">        List of diagnostics produced by one or more validators.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[Diagnostic]</span>
<span class="sd">        De-duplicated diagnostics (stable order of first occurrence preserved).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">diags</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;severity&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="n">_canon_details</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;details&quot;</span><span class="p">,</span> <span class="p">{})))</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ---- Individual validators ---------------------------------------------------</span>
    
<div class="viewcode-block" id="validate_first_step_inputs">
<a class="viewcode-back" href="../../_autosummary/llm_procedure_generation_ga.validators.html#llm_procedure_generation_ga.validators.validate_first_step_inputs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_first_step_inputs</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">JSONDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforce the **Step 1** input contract: it must be exactly ``[&quot;problem_text&quot;]``.</span>

<span class="sd">    Rationale</span>
<span class="sd">    ---------</span>
<span class="sd">    In the global-state design, the only external input is the problem text.</span>
<span class="sd">    All additional information must be produced by earlier steps (which, for Step 1,</span>
<span class="sd">    means there are none), so Step 1 cannot declare any other inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p</span>
<span class="sd">        Procedure JSON (already parsed to Python dict).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[Diagnostic]</span>
<span class="sd">        ``fatal`` if Step 1 inputs differ from exactly ``[&quot;problem_text&quot;]``, otherwise empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
    <span class="n">step1_inputs</span> <span class="o">=</span> <span class="n">_names</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;inputs&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">step1_inputs</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;problem_text&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="s2">&quot;fatal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;REWRITE_FIRST_STEP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Step 1 inputs must be exactly [&#39;problem_text&#39;].&quot;</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="n">step1_inputs</span><span class="p">}</span>
        <span class="p">}]</span>
    <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="validate_final_step_output">
<a class="viewcode-back" href="../../_autosummary/llm_procedure_generation_ga.validators.html#llm_procedure_generation_ga.validators.validate_final_step_output">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_final_step_output</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">JSONDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Require the **final step** to output exactly ``[&quot;final_answer&quot;]``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    ``final_answer`` is terminal and consumed outside the procedure. The final step</span>
<span class="sd">    should describe the final answer (no numeric computation here).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p</span>
<span class="sd">        Procedure JSON (already parsed to Python dict).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[Diagnostic]</span>
<span class="sd">        ``fatal`` if the last step&#39;s outputs are not exactly ``[&quot;final_answer&quot;]``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: in most cases, this issue occurs when the final answer is derived in the final step but just not assigned the corresponding variable name. Can we somehow check if the answer is given and if so just change the existing variable name to `final_answer`?</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
    <span class="n">final_outputs</span> <span class="o">=</span> <span class="n">_names</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">final_outputs</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;final_answer&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="s2">&quot;fatal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;EXTEND_PROCEDURE_TO_FINAL&quot;</span> <span class="k">if</span> <span class="s2">&quot;final_answer&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_outputs</span> <span class="k">else</span> <span class="s2">&quot;ADD_FINAL_STEP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Final step must produce exactly [&#39;final_answer&#39;].&quot;</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;found&quot;</span><span class="p">:</span> <span class="n">final_outputs</span><span class="p">}</span>
        <span class="p">}]</span>
    <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="validate_inputs_resolvable_from_prior">
<a class="viewcode-back" href="../../_autosummary/llm_procedure_generation_ga.validators.html#llm_procedure_generation_ga.validators.validate_inputs_resolvable_from_prior">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_inputs_resolvable_from_prior</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure every step input is **available** from global state when the step runs.</span>

<span class="sd">    Rule</span>
<span class="sd">    ----</span>
<span class="sd">    For each step *i* and input variable *v*:</span>
<span class="sd">      - Either ``v == &quot;problem_text&quot;``, or</span>
<span class="sd">      - some prior step *k &lt; i* produced ``v`` in its outputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p</span>
<span class="sd">        Procedure JSON (already parsed to Python dict).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[Diagnostic]</span>
<span class="sd">        ``fatal`` diagnostics for inputs that cannot be traced to ``problem_text`` or</span>
<span class="sd">        some earlier step&#39;s outputs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>

    <span class="c1"># map var -&gt; first producer step index</span>
    <span class="n">producers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_names</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]):</span>
            <span class="n">producers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_names</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;problem_text&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">producers</span> <span class="ow">or</span> <span class="n">producers</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">:</span>
                <span class="c1"># TODO: add more details to help the LLM create a new step or something to generate the missing variable</span>
                <span class="n">diags</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="s2">&quot;fatal&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;ADD_MISSING_PRODUCER&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Input &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39; of Step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> is not produced by any prior step.&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;step_id&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>
                <span class="p">})</span>
    <span class="k">return</span> <span class="n">diags</span></div>


<div class="viewcode-block" id="validate_no_redefine_existing_vars">
<a class="viewcode-back" href="../../_autosummary/llm_procedure_generation_ga.validators.html#llm_procedure_generation_ga.validators.validate_no_redefine_existing_vars">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_no_redefine_existing_vars</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">JSONDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discourage **shadowing**: warn if a step re-uses an already-produced variable name.</span>

<span class="sd">    Rationale</span>
<span class="sd">    ---------</span>
<span class="sd">    In a global state, silently overwriting prior variables can confuse both the LLM</span>
<span class="sd">    and debuggers. Prefer distinct names or explicitly mark transformations</span>
<span class="sd">    (e.g., ``normalized_total`` instead of re-using ``total``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p</span>
<span class="sd">        Procedure JSON (already parsed to Python dict).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[Diagnostic]</span>
<span class="sd">        ``repairable`` diagnostics suggesting renames for redefined variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]):</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="n">_names</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">])</span>
        <span class="n">redefs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">!=</span> <span class="s2">&quot;final_answer&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">redefs</span><span class="p">:</span>
            <span class="n">diags</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="s2">&quot;repairable&quot;</span><span class="p">,</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;PATCH_LOCALLY&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Avoid re-defining existing variables at Step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">redefs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;step_id&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="s2">&quot;consider_renaming&quot;</span><span class="p">:</span> <span class="n">redefs</span><span class="p">}</span>
            <span class="p">})</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">outs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">diags</span></div>


<div class="viewcode-block" id="validate_unused_outputs">
<a class="viewcode-back" href="../../_autosummary/llm_procedure_generation_ga.validators.html#llm_procedure_generation_ga.validators.validate_unused_outputs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_unused_outputs</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">JSONDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flag **dead variables**: outputs never consumed by any later step.</span>

<span class="sd">    Exemptions</span>
<span class="sd">    ----------</span>
<span class="sd">    - ``final_answer`` (terminal output)</span>
<span class="sd">    - ``problem_text`` (not an output; guarded for safety)</span>

<span class="sd">    Algorithm</span>
<span class="sd">    ---------</span>
<span class="sd">    Walk backwards through steps, accumulating the set of inputs that appear</span>
<span class="sd">    at or after each position. Any output at index *i* that never appears in a</span>
<span class="sd">    later step&#39;s inputs is considered unused.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p</span>
<span class="sd">        Procedure JSON (already parsed to Python dict).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[Diagnostic]</span>
<span class="sd">        ``repairable`` diagnostics suggesting removal of unused outputs per step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

    <span class="c1"># Build, for each index i, a set of inputs used by steps after i.</span>
    <span class="n">future_inputs_after</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">future</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">future_inputs_after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_names</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;inputs&quot;</span><span class="p">]))</span>
        <span class="c1"># also add inputs of current step so that earlier outputs see this as &quot;future&quot;</span>
        <span class="n">future</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_names</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;inputs&quot;</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_names</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;final_answer&quot;</span><span class="p">,</span> <span class="s2">&quot;problem_text&quot;</span><span class="p">}]</span>
        <span class="n">unused</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">future_inputs_after</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">unused</span><span class="p">:</span>
            <span class="n">diags</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="s2">&quot;repairable&quot;</span><span class="p">,</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;PATCH_LOCALLY&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Remove unused outputs at Step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">unused</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;step_id&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="s2">&quot;remove_from_outputs&quot;</span><span class="p">:</span> <span class="n">unused</span><span class="p">}</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="n">diags</span></div>


<span class="c1"># ---- Master validator (composable) ------------------------------------------</span>

<span class="n">Validator</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">JSONDict</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]]</span>
<span class="sd">&quot;&quot;&quot;Callable signature for a validator function.&quot;&quot;&quot;</span>

<span class="n">DEFAULT_VALIDATORS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Validator</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">validate_first_step_inputs</span><span class="p">,</span>
    <span class="n">validate_final_step_output</span><span class="p">,</span>
    <span class="n">validate_inputs_resolvable_from_prior</span><span class="p">,</span>
    <span class="n">validate_no_redefine_existing_vars</span><span class="p">,</span>
    <span class="n">validate_unused_outputs</span>
<span class="p">]</span>
<span class="sd">&quot;&quot;&quot;Default validator suite for global-state procedures with a strict Step 1 and final step.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="validate_procedure_structured">
<a class="viewcode-back" href="../../_autosummary/llm_procedure_generation_ga.validators.html#llm_procedure_generation_ga.validators.validate_procedure_structured">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_procedure_structured</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">JSONDict</span><span class="p">,</span> <span class="n">validators</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Validator</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a composed set of validators and return de-duplicated diagnostics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p</span>
<span class="sd">        Procedure JSON to validate (already parsed to Python dict).</span>
<span class="sd">    validators</span>
<span class="sd">        Optional custom list of validator callables. If omitted, uses</span>
<span class="sd">        :data:`DEFAULT_VALIDATORS`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[Diagnostic]</span>
<span class="sd">        De-duplicated diagnostics suitable for a repair loop.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validators</span> <span class="o">=</span> <span class="n">validators</span> <span class="ow">or</span> <span class="n">DEFAULT_VALIDATORS</span>
    <span class="n">all_diags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Diagnostic</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">validators</span><span class="p">:</span>
        <span class="n">all_diags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_dedup_diags</span><span class="p">(</span><span class="n">all_diags</span><span class="p">)</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Malia Barker
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=d6b6a36a"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    </body>
</html>